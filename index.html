<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>ProVoid Lightning | Ultra</title>
    <style type="text/css">
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600&display=swap');

        :root {
            --bg-color: #080808;
            --text-color: #f0f0f0;
            --accent-color: #ffffff;
            --hover-color: #1a1a1a;
            --border-color: #222222;
            --secondary-bg: #0d0d0d;
            --secondary-text: #808080;
            --transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --border-radius: 8px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            width: 100%; height: 100vh;
            background: var(--bg-color);
            color: var(--text-color);
            font-family: 'JetBrains Mono', monospace;
            overflow: hidden;
        }

        #main-container { display: flex; flex-direction: column; height: 100%; }

        #tab-bar {
            height: 54px; display: flex; align-items: center;
            padding: 0 15px; gap: 8px;
            background: #0a0a0a; border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
        }

        .tab {
            height: 36px; min-width: 140px; padding: 0 12px;
            background: var(--secondary-bg); border: 1px solid var(--border-color);
            border-radius: 6px; display: flex; align-items: center; justify-content: space-between;
            cursor: grab; transition: var(--transition); font-size: 13px; color: var(--secondary-text);
            user-select: none;
        }

        .tab.active {
            background: linear-gradient(145deg, #1d1d1d, #111);
            border-color: #555; color: #fff; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.5), inset 0 0 5px rgba(255,255,255,0.05);
        }

        .tab.dragging { opacity: 0.2; border: 1px dashed #fff; }

        .tab-input { 
            background: transparent; border: none; color: #fff; 
            outline: none; width: 90px; font-family: inherit; 
            border-bottom: 1px solid var(--accent-color);
        }

        .tab-close { opacity: 0.3; font-size: 16px; cursor: pointer; transition: 0.2s; }
        .tab-close:hover { color: #ff5555; opacity: 1; }

        #new-tab-btn {
            min-width: 34px; height: 34px; border-radius: 6px;
            border: 1px solid var(--border-color); display: flex;
            align-items: center; justify-content: center;
            cursor: pointer; transition: 0.3s; color: var(--secondary-text);
        }
        #new-tab-btn:hover { background: var(--hover-color); color: #fff; border-color: #444; }

        #palette {
            position: fixed; top: -100px; left: 50%; transform: translateX(-50%);
            width: 450px; background: rgba(15, 15, 15, 0.95); 
            border: 1px solid #333; border-radius: 10px; z-index: 10000; padding: 12px;
            transition: top 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28); 
            box-shadow: 0 25px 50px rgba(0,0,0,0.9);
            backdrop-filter: blur(10px);
        }
        #palette.open { top: 60px; }
        #palette input {
            width: 100%; background: #000; border: 1px solid #222;
            color: #fff; padding: 10px; border-radius: 5px; 
            outline: none; font-family: inherit; font-size: 14px;
        }

        #container { flex-grow: 1; }

        .toast-container { position: fixed; bottom: 25px; right: 25px; display: flex; flex-direction: column-reverse; gap: 8px; z-index: 9999; }
        .toast {
            padding: 12px 20px; background: #0f0f0f; border: 1px solid #222; 
            border-left: 3px solid var(--accent-color); border-radius: 4px;
            transform: translateX(160%); transition: var(--transition); 
            font-size: 12px; min-width: 250px; display: flex; align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .toast.show { transform: translateX(0); }
        .toast-tag { color: #555; font-weight: bold; margin-right: 12px; font-size: 10px; text-transform: uppercase; }
    </style>
</head>
<body>

    <div id="palette">
        <input type="text" id="palette-input" placeholder="Type a command (e.g. >clear) or script name...">
    </div>

    <div id="main-container">
        <div class="toast-container" id="toast-container"></div>
        <div id="tab-bar">
            <div id="new-tab-btn">+</div>
        </div>
        <div id="container"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.33.0/min/vs/loader.min.js"></script>
    <script>
        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.33.0/min/vs' } });

        let editor, activeTab = null, tabs = [];

        // --- C# BRIDGE FUNCTIONS (FIXES CLEAR & SCRIPT TREE) ---
        window.SetText = function(text) {
            if (editor) {
                editor.setValue(text);
                if (activeTab) activeTab.content = text; // Sync current tab
            }
        };

        window.GetText = function() {
            return editor ? editor.getValue() : "";
        };

        // --- Notification Engine ---
        function notify(msg, tag = "INFO") {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `<span class="toast-tag">${tag}</span> <span>${msg}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 50);
            setTimeout(() => { 
                toast.classList.remove('show'); 
                setTimeout(() => toast.remove(), 500); 
            }, 3000);
        }

        // --- Persistence ---
        function saveSession() {
            if (activeTab) activeTab.content = editor.getValue();
            const data = tabs.map(t => ({ name: t.name, content: t.content }));
            localStorage.setItem('provoid_lightning_v2', JSON.stringify(data));
        }

        function loadSession() {
            const data = localStorage.getItem('provoid_lightning_v2');
            if (data) {
                const saved = JSON.parse(data);
                saved.forEach(t => createTab(t.name, t.content, false));
            } else {
                createTab('Main.lua', '-- Welcome to ProVoid\nprint("Hello World")');
            }
        }

        function getNextTabName() {
            let i = 1;
            while (true) {
                const name = `Script ${i}`;
                if (!tabs.some(t => t.name === name)) return name;
                i++;
            }
        }

        function createTab(name = null, content = '-- ProVoid Script', isNew = true) {
            const finalName = name || getNextTabName();
            const tab = {
                id: Math.random().toString(36).substr(2, 9),
                name: finalName,
                content: content,
                element: document.createElement('div')
            };

            tab.element.className = 'tab';
            tab.element.draggable = true;
            tab.element.innerHTML = `<span class="tab-lbl">${tab.name}</span><span class="tab-close">Ã—</span>`;
            
            tab.element.addEventListener('dragstart', () => tab.element.classList.add('dragging'));
            tab.element.addEventListener('dragend', () => {
                tab.element.classList.remove('dragging');
                reorderTabs();
            });

            tab.element.onclick = () => activateTab(tab);
            tab.element.ondblclick = () => renameTab(tab);
            tab.element.querySelector('.tab-close').onclick = (e) => {
                e.stopPropagation();
                closeTab(tab.id);
            };

            const btn = document.getElementById('new-tab-btn');
            document.getElementById('tab-bar').insertBefore(tab.element, btn);
            tabs.push(tab);
            activateTab(tab);
            if(isNew) notify(`Created ${finalName}`, "FILE");
            return tab;
        }

        function activateTab(tab) {
            if (activeTab) {
                activeTab.content = editor.getValue();
                activeTab.element.classList.remove('active');
            }
            activeTab = tab;
            tab.element.classList.add('active');
            if (editor) {
                editor.setValue(tab.content);
                monaco.editor.setModelLanguage(editor.getModel(), "lua");
            }
        }

        function renameTab(tab) {
            const lbl = tab.element.querySelector('.tab-lbl');
            const oldName = tab.name;
            const input = document.createElement('input');
            input.className = 'tab-input';
            input.value = oldName;
            lbl.replaceWith(input);
            input.focus();
            input.select();

            const finish = () => {
                const newName = input.value.trim() || oldName;
                tab.name = newName;
                const newLbl = document.createElement('span');
                newLbl.className = 'tab-lbl';
                newLbl.innerText = newName;
                input.replaceWith(newLbl);
                if(newName !== oldName) saveSession();
            };
            input.onblur = finish;
            input.onkeydown = (e) => { if(e.key === 'Enter') finish(); };
        }

        function closeTab(id) {
            if (tabs.length <= 1) return notify("Last script cannot be closed", "ERROR");
            const idx = tabs.findIndex(t => t.id === id);
            tabs[idx].element.remove();
            tabs.splice(idx, 1);
            if (activeTab.id === id) activateTab(tabs[tabs.length - 1] || tabs[0]);
            saveSession();
        }

        function reorderTabs() {
            const currentElements = [...document.querySelectorAll('.tab')];
            const newTabs = [];
            currentElements.forEach(el => {
                const found = tabs.find(t => t.element === el);
                if (found) newTabs.push(found);
            });
            tabs = newTabs;
            saveSession();
        }

        const tabBar = document.getElementById('tab-bar');
        tabBar.addEventListener('dragover', e => {
            e.preventDefault();
            const dragging = document.querySelector('.dragging');
            const afterElement = getDragAfterElement(tabBar, e.clientX);
            if (afterElement == null) {
                tabBar.insertBefore(dragging, document.getElementById('new-tab-btn'));
            } else {
                tabBar.insertBefore(dragging, afterElement);
            }
        });

        function getDragAfterElement(container, x) {
            const draggables = [...container.querySelectorAll('.tab:not(.dragging)')];
            return draggables.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = x - box.left - box.width / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else { return closest; }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // --- Monaco Initialization ---
        require(['vs/editor/editor.main'], function() {
            monaco.editor.defineTheme('provoidUltra', {
                base: 'vs-dark',
                inherit: true,
                rules: [],
                colors: {
                    'editor.background': '#080808',
                    'editor.lineHighlightBackground': '#111111',
                    'editorCursor.foreground': '#ffffff',
                    'editorLineNumber.foreground': '#333333',
                    'editorIndentGuide.background': '#151515'
                }
            });

            editor = monaco.editor.create(document.getElementById('container'), {
                theme: 'provoidUltra',
                language: 'lua',
                fontSize: 14,
                fontFamily: 'JetBrains Mono',
                automaticLayout: true,
                padding: { top: 15 },
                minimap: { enabled: true },
                smoothScrolling: true,
                cursorBlinking: "smooth"
            });

            loadSession();
            editor.onDidChangeModelContent(() => { saveSession(); });
        });

        document.getElementById('new-tab-btn').onclick = () => createTab();
    </script>
</body>
</html>
